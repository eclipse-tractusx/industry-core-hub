{{- /*
* Eclipse Tractus-X - Industry Core Hub
*
* Copyright (c) 2025 LKS Next
* Copyright (c) 2025 Contributors to the Eclipse Foundation
*
* See the NOTICE file(s) distributed with this work for additional
* information regarding copyright ownership.
*
* This program and the accompanying materials are made available under the
* terms of the Apache License, Version 2.0 which is available at
* https://www.apache.org/licenses/LICENSE-2.0.
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
* WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
* License for the specific language governing permissions and limitations
* under the License.
*
* SPDX-License-Identifier: Apache-2.0
*/}}
{{- if and .Values.keycloak.enabled .Values.keycloak.realmImport.enabled (eq .Values.keycloak.realmImport.method "job") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-realm-import
  namespace: {{ .Release.Namespace | default "default" | quote }}
  labels:
    {{- include "industry-core-hub.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak-import
  annotations:
    # Helm hooks (for helm install/upgrade)
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    # ArgoCD hooks (for ArgoCD deployments)
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "2"
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        {{- include "industry-core-hub.labels" . | nindent 8 }}
        app.kubernetes.io/component: keycloak-import
    spec:
      restartPolicy: OnFailure
      containers:
        - name: realm-import
          image: curlimages/curl:8.5.0
          imagePullPolicy: IfNotPresent
          env:
            - name: KEYCLOAK_URL
              value: "http://{{ .Release.Name }}-keycloak:80"
            - name: KEYCLOAK_ADMIN
              value: "{{ .Values.keycloak.auth.adminUser }}"
            - name: KEYCLOAK_ADMIN_PASSWORD
              value: "{{ .Values.keycloak.auth.adminPassword }}"
            {{- range $user := .Values.keycloak.realm.users }}
            - name: {{ $user.username | upper | replace "-" "_" }}_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $.Release.Name }}-keycloak-realm-users
                  key: {{ $user.username }}-password
            - name: {{ $user.username | upper | replace "-" "_" }}_EMAIL
              value: "{{ $user.email }}"
            {{- end }}
          volumeMounts:
            - name: realm-data
              mountPath: /import
          command:
            - /bin/sh
            - -c
          args:
            - |
              set -e
              echo "Starting realm import process..."
              
              # Wait for Keycloak to be available
              echo "Waiting for Keycloak at $KEYCLOAK_URL..."
              RETRIES=0
              MAX_RETRIES=60
              while [ $RETRIES -lt $MAX_RETRIES ]; do
                echo "Attempt $((RETRIES + 1))/$MAX_RETRIES: Checking Keycloak availability..."
                
                # Try multiple endpoints to check if Keycloak is ready
                if curl -f -s "$KEYCLOAK_URL/health/ready" >/dev/null 2>&1 || \
                   curl -f -s "$KEYCLOAK_URL/realms/master" >/dev/null 2>&1 || \
                   curl -f -s "$KEYCLOAK_URL/auth/realms/master" >/dev/null 2>&1; then
                  echo "✓ Keycloak is ready!"
                  sleep 5  # Extra wait to ensure full initialization
                  break
                fi
                
                RETRIES=$((RETRIES + 1))
                if [ $RETRIES -eq $MAX_RETRIES ]; then
                  echo "✗ ERROR: Keycloak not available after 10 minutes"
                  echo "Debug: Trying to connect to $KEYCLOAK_URL"
                  curl -v "$KEYCLOAK_URL/health/ready" 2>&1 || true
                  exit 1
                fi
                sleep 10
              done
              
              # Get admin token (try both old and new Keycloak paths)
              echo "Getting admin token..."
              
              # Try new Keycloak path first (Keycloak 17+)
              TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "username=$KEYCLOAK_ADMIN" \
                -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
                -d "grant_type=password" \
                -d "client_id=admin-cli" 2>/dev/null | \
                sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p')
              
              # If that fails, try old Keycloak path (Keycloak 16 and earlier)
              if [ -z "$TOKEN" ]; then
                echo "Trying legacy Keycloak path..."
                TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/auth/realms/master/protocol/openid-connect/token" \
                  -H "Content-Type: application/x-www-form-urlencoded" \
                  -d "username=$KEYCLOAK_ADMIN" \
                  -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
                  -d "grant_type=password" \
                  -d "client_id=admin-cli" 2>/dev/null | \
                  sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p')
              fi
              
              if [ -z "$TOKEN" ]; then
                echo "✗ ERROR: Failed to get admin token"
                echo "Debug: KEYCLOAK_ADMIN=$KEYCLOAK_ADMIN"
                echo "Debug: Attempting token request..."
                curl -v -X POST "$KEYCLOAK_URL/realms/master/protocol/openid-connect/token" \
                  -H "Content-Type: application/x-www-form-urlencoded" \
                  -d "username=$KEYCLOAK_ADMIN" \
                  -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
                  -d "grant_type=password" \
                  -d "client_id=admin-cli" 2>&1 || true
                exit 1
              fi
              
              echo "✓ Successfully obtained admin token"
              
              # Check if realm already exists
              REALM_NAME="ICHub"
              echo "Checking if realm '$REALM_NAME' exists..."
              
              # Determine correct API path (try new path first, then legacy)
              ADMIN_API_PATH=""
              if curl -s -f -H "Authorization: Bearer $TOKEN" "$KEYCLOAK_URL/admin/realms/$REALM_NAME" >/dev/null 2>&1; then
                ADMIN_API_PATH="/admin"
                echo "Using new Keycloak API path: /admin"
              elif curl -s -f -H "Authorization: Bearer $TOKEN" "$KEYCLOAK_URL/auth/admin/realms/$REALM_NAME" >/dev/null 2>&1; then
                ADMIN_API_PATH="/auth/admin"
                echo "Using legacy Keycloak API path: /auth/admin"
              else
                # Realm doesn't exist yet, try to detect from token endpoint
                if [ -n "$(echo $KEYCLOAK_URL | grep -o '/auth')" ] || curl -s -f "$KEYCLOAK_URL/auth/realms/master" >/dev/null 2>&1; then
                  ADMIN_API_PATH="/auth/admin"
                  echo "Detected legacy Keycloak, using: /auth/admin"
                else
                  ADMIN_API_PATH="/admin"
                  echo "Detected new Keycloak, using: /admin"
                fi
              fi
              
              REALM_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer $TOKEN" \
                "$KEYCLOAK_URL$ADMIN_API_PATH/realms/$REALM_NAME")
              
              if [ "$REALM_EXISTS" = "200" ]; then
                echo "✓ Realm '$REALM_NAME' already exists"
              else
                echo "Importing realm '$REALM_NAME'..."
                echo "Using API endpoint: $KEYCLOAK_URL$ADMIN_API_PATH/realms"
                
                IMPORT_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "$KEYCLOAK_URL$ADMIN_API_PATH/realms" \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d @/import/realm-export.json)
                
                HTTP_CODE=$(echo "$IMPORT_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
                RESPONSE_BODY=$(echo "$IMPORT_RESPONSE" | sed '/HTTP_CODE:/d')
                
                if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
                  echo "✓ Realm '$REALM_NAME' imported successfully (HTTP $HTTP_CODE)"
                else
                  echo "✗ ERROR: Failed to import realm '$REALM_NAME' (HTTP $HTTP_CODE)"
                  echo "Response: $RESPONSE_BODY"
                  exit 1
                fi
              fi
              
              # Set passwords for all users
              {{- range $user := .Values.keycloak.realm.users }}
              echo "Processing user '{{ $user.username }}'..."
              
              # Get user ID
              USER_ID=$(curl -s -X GET "$KEYCLOAK_URL$ADMIN_API_PATH/realms/$REALM_NAME/users?username={{ $user.username }}" \
                -H "Authorization: Bearer $TOKEN" | \
                sed -n 's/.*"id":"\([^"]*\)".*/\1/p' | head -1)
              
              if [ -z "$USER_ID" ]; then
                echo "⚠ WARNING: User '{{ $user.username }}' not found in realm, skipping password setup"
              else
                echo "Found user '{{ $user.username }}' with ID: $USER_ID"
                
                # Set password using Admin API
                HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
                  "$KEYCLOAK_URL$ADMIN_API_PATH/realms/$REALM_NAME/users/$USER_ID/reset-password" \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d "{\"type\":\"password\",\"value\":\"${{ $user.username | upper | replace "-" "_" }}_PASSWORD\",\"temporary\":false}")
                
                if [ "$HTTP_STATUS" = "204" ] || [ "$HTTP_STATUS" = "200" ]; then
                  echo "✓ Password set successfully for user '{{ $user.username }}'"
                else
                  echo "✗ Failed to set password for user '{{ $user.username }}' (HTTP $HTTP_STATUS)"
                fi
              fi
              echo ""
              {{- end }}
              
              echo "Realm import process completed successfully!"
          resources:
            {{- toYaml .Values.keycloak.realmImport.resources | nindent 12 }}
      volumes:
        - name: realm-data
          configMap:
            name: {{ .Release.Name }}-keycloak-realm-data
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
{{- end }}
